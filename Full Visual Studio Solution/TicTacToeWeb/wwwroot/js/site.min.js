let transportType = signalR.TransportType.WebSockets;
let http = new signalR.HttpConnection(`http://${document.location.host}/tictactoeroom`, { transport: transportType });
let connection = new signalR.HubConnection(http);
connection.start();

connection.on('SendMessage', appendMessage);
connection.on('SetPlayer', setPlayer);
connection.on('ResetGame', resetGame);
connection.on('ToggleControls', () => {
    toggleControl('inLobby');
    toggleControl('inGame');
});
connection.on('UpdateTile', updateTile);

document.getElementById('sendMessage').addEventListener('submit', event => {
    let message = document.getElementById('message').value;
    let roomID = document.getElementById('roomId').value;
    document.getElementById('message').value = '';

    connection.invoke('BroadcastMessage', message, roomID);
    event.preventDefault();
});

document.getElementById('joinRoom').addEventListener('submit', event => {
    let roomID = document.getElementById('roomId').value;
    connection.invoke('JoinRoom', roomID);
    event.preventDefault();
});

document.getElementById('leaveRoom').addEventListener('submit', event => {
    connection.invoke('LeaveRoom');
    event.preventDefault();
});

function appendMessage(message) {
    let line = document.createElement('li');
    line.innerText = message;
    document.getElementById('messages').appendChild(line);
};

function setPlayer(playerID) {
    document.getElementById('playerDetails').innerHTML = "You are player " + playerID;
}

function resetGame() {
    let game = document.getElementById('game');
    Array.from(game.getElementsByClassName('btnBoard')).forEach(function (tile) {
        tile.value = "-";
    });
};

function toggleControl(controlName) {
    let control = document.getElementById(controlName);
    if (control.style.display == "block")
        control.style.display = "none";
    else
        control.style.display = "block";
};

function makeMove(pos) {
    let roomID = document.getElementById('roomId').value;
    connection.invoke('MakeMove', roomID, pos);
}

function updateTile(pos, symbol) {
    let game = document.getElementById('game');
    game.getElementsByClassName('btnBoard')[pos].value = symbol;
}